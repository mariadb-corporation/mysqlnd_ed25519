name: Windows Extension Build (php-windows-builder)

# Trigger the workflow on every push to 'main', on pull requests, and when a release is published
on:
  push:
    branches:
      - main
      - win-build
  pull_request:
    branches:
      - main
  release:
    types: [published]

jobs:
  build:
    # Use the stable windows-2022 runner image, which includes VS17 (Visual Studio 2022).
    runs-on: windows-2022
    permissions:
      contents: read
    
    # Define outputs to pass the version string to the release job
    outputs:
      extension_version: ${{ steps.get_version.outputs.version }}

    strategy:
      fail-fast: false
      matrix:
        # The required PHP versions
        php-version: ['8.2', '8.3', '8.4']
        # 64-bit and 32-bit architecture
        arch: ['x64', 'x86']
        # Thread Safe (ts) and Non-Thread Safe (nts) Builds
        ts: ['ts', 'nts']

    steps:
      - name: Checkout Extension Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 1: Get the exact version string from the C header file
      - name: Get Extension Version
        id: get_version
        shell: powershell
        # Searches php_mysqlnd_ed25519.h for the version definition and sets it as an output
        run: |
          # Use the correct define name: PHP_MARIADB_AUTH_PLUGIN_VERSION
          $version = Get-Content "php_mysqlnd_ed25519.h" | Select-String -Pattern '#define PHP_MARIADB_AUTH_PLUGIN_VERSION'
          $version = $version -split '"'
          
          # FIX: Use the modern, supported method to set output variables
          "version=$($version[1])" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding UTF8 -Append
        continue-on-error: false

      # Step 2: Build the extension using the php-windows-builder
      - name: Build Extension (PHP ${{ matrix.php-version }} - ${{ matrix.ts }} - ${{ matrix.arch }})
        uses: php/php-windows-builder/extension@v1
        with:
          php-version: ${{ matrix.php-version }}
          arch: ${{ matrix.arch }}
          ts: ${{ matrix.ts }}
          extension-url: https://github.com/mariadb-corporation/mysqlnd_ed25519
          args: --with-mysqlnd_ed25519
          # FIX: Uses explicit comma-separated string format for libraries
          libs: "libsodium-1"
            
      # Step 3: Upload the created DLLs as workflow artifacts
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          # Artifact name includes the version parsed from the code, preventing 409 Conflict.
          name: mysqlnd_ed25519-${{ steps.get_version.outputs.version }}-${{ matrix.php-version }}-${{ matrix.ts }}-${{ matrix.arch }}
          # Corrected glob pattern to find the DLL inside the build subdirectory.
          path: build/**/php_mysqlnd_ed25519.dll
          if-no-files-found: error
          
  release:
    runs-on: ubuntu-latest
    # Wait for the build job to complete
    needs: build
    # Only run this job when the workflow was triggered by a published release
    if: ${{ github.event_name == 'release' }}
    
    permissions:
      contents: write

    steps:
      - name: Download all built artifacts
        uses: actions/download-artifact@v4
        with:
          # Downloads all artifacts whose names start with 'mysqlnd_ed25519-'
          pattern: mysqlnd_ed25519-*
          path: artifacts
          
      # Step 4: Consolidate and Rename DLLs
      - name: Consolidate and Rename DLLs
        shell: bash
        run: |
          mkdir release_assets
          # Loop through every downloaded artifact directory (e.g., artifacts/mysqlnd_ed25519-1.0.0-8.4-nts-x64)
          for artifact_dir in artifacts/*; do
            # Extract the full version/matrix info from the directory name
            MATRIX_INFO=$(basename "$artifact_dir" | sed 's/^mysqlnd_ed25519-//')
            
            # Find the single DLL file inside the artifact directory (which might be in a subdir)
            DLL_FILE=$(find "$artifact_dir" -name "*.dll" | head -n 1)

            if [ -n "$DLL_FILE" ]; then
                # Construct the final desired filename: php_mysqlnd_ed25519-VERSION-PHP_MATRIX.dll
                NEW_NAME="php_mysqlnd_ed25519-$MATRIX_INFO.dll"
                
                echo "Renaming $DLL_FILE to $NEW_NAME"
                cp "$DLL_FILE" "release_assets/$NEW_NAME"
            else
                echo "Warning: No DLL found in $artifact_dir. Skipping."
            fi
          done

      # Step 5: Upload all consolidated and correctly named DLLs to the GitHub Release
      - name: Upload Release Assets
        # Use softprops/action-gh-release for reliable multi-file upload
        uses: softprops/action-gh-release@v1
        with:
          files: release_assets/*
          tag_name: ${{ github.event.release.tag_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          # Ensures old assets are overwritten on re-runs
          overwrite: true

